<script is:inline>
  console.log("GLOBAL QUOTE FORM HANDLER LOADED");

  function bindQuoteForms() {
    const forms = document.querySelectorAll(
      'form.kl-quoteform__grid[action="/api/quote"][method="POST"]'
    );

    forms.forEach((form) => {
      // Prevent duplicate bindings when navigating
      if (form.dataset.klBound === "1") return;
      form.dataset.klBound = "1";

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Honeypot field safety (if present)
        const hp = form.querySelector('input[name="website"]');
        if (hp) hp.value = "";

        try {
          const res = await fetch("/api/quote", {
            method: "POST",
            headers: { Accept: "application/json" },
            body: new FormData(form),
          });

          const data = await res.json().catch(() => ({}));

          if (res.ok && data?.ok === true) {
            window.location.href = "/thank-you/";
            return;
          }

          console.log("QUOTE API ERROR:", res.status, data);
          alert("Not sent. Please try again.");
        } catch (err) {
          console.log("QUOTE API NETWORK ERROR:", err);
          alert("Network error. Please try again.");
        }
      });
    });
  }

  // Runs on first page load + every transition navigation
  document.addEventListener("astro:page-load", bindQuoteForms);
</script>
